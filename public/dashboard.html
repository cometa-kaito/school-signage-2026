<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Signage Dashboard (ç®¡ç†è€…)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="auth-style.css">
    <link rel="stylesheet" href="dashboard-style.css">
    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å°‚ç”¨: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æœ‰åŠ¹åŒ– -->
    <style>
        html, body {
            overflow: auto !important;
            height: auto !important;
            min-height: 100% !important;
        }
        .container {
            overflow: visible !important;
            height: auto !important;
            min-height: 100vh !important;
        }
    </style>
    <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Firebase SDKãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç† -->
    <script>
        window.firebaseLoaded = false;
        setTimeout(function() {
            if (!window.firebaseLoaded) {
                var overlay = document.getElementById('loadingOverlay');
                var login = document.getElementById('loginContainer');
                var error = document.getElementById('loginError');
                if (overlay) overlay.style.display = 'none';
                if (login) login.style.display = 'flex';
                if (error) {
                    error.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚Firebaseã¸ã®æ¥ç¶šãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    error.style.display = 'block';
                }
            }
        }, 5000);
    </script>
</head>
<body>
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            <div id="loginError" class="error-msg"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required 
                           placeholder="admin@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required 
                           placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
                </div>
                <button type="submit" id="loginBtn" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            
            <div class="divider"><span>ã¾ãŸã¯</span></div>
            
            <button type="button" id="googleLoginBtn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            
            <p class="login-note">â€»ç®¡ç†è€…ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™</p>
        </div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <div id="appContainer">
        <div class="user-bar-fixed">
            <span id="userEmail" class="user-email"></span>
            <button id="logoutBtn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>

        <div class="container">
            <main class="info-area">
                <header class="header-block">
                    <div class="date-group">
                        <span id="current-date" class="date-text">--æœˆ--æ—¥</span>
                        <span id="current-day" class="day-badge">--</span>
                        <span id="current-time" class="time-text">--:--</span>
                    </div>
                    <h1 id="class-name" class="class-title editable" 
                        onclick="window.dashboard && window.dashboard.openConfigModal()">--</h1>
                </header>

                <div class="content-grid">
                    <section class="card schedule-section">
                        <h2><span class="icon">ğŸ“…</span> ä»Šå¾Œ3æ—¥é–“ã®äºˆå®š</h2>
                        <div id="schedule-grid" class="schedule-grid-container"></div>
                    </section>

                    <section class="card notice-section">
                        <h2><span class="icon">ğŸ“¢</span> å„ç¨®é€£çµ¡</h2>
                        <ul id="notice-list" class="list-group"></ul>
                        <div class="btn-add-area" 
                             onclick="window.dashboard && window.dashboard.openAddModal('notice')">+ é€£çµ¡ã‚’è¿½åŠ </div>
                    </section>

                    <section class="card assignment-section">
                        <h2><span class="icon">âš ï¸</span> æå‡ºç‰©ç®¡ç†</h2>
                        <div class="table-wrapper">
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th width="30%">æœŸé™</th>
                                        <th width="20%">ç§‘ç›®</th>
                                        <th width="40%">æå‡ºç‰©</th>
                                        <th width="10%"></th>
                                    </tr>
                                </thead>
                                <tbody id="assignment-list"></tbody>
                            </table>
                        </div>
                        <div class="btn-add-area" 
                             onclick="window.dashboard && window.dashboard.openAddModal('assignment')">+ æå‡ºç‰©ã‚’è¿½åŠ </div>
                    </section>
                </div>

                <footer class="branding">Edix by Rebounder (ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰)</footer>
            </main>

            <aside class="ad-area">
                <div class="ad-container" onclick="window.dashboard && window.dashboard.openAdManager()">
                    <img id="ad-image" src="" alt="Advertisement">
                    <div class="img-edit-overlay">
                        <div class="img-edit-text">ç”»åƒã‚’ç®¡ç†ã™ã‚‹</div>
                        <div class="img-edit-sub">è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ (æœ€å¤§5æš)</div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="edit-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header" id="modal-title">ç·¨é›†</div>
                <div id="modal-body"></div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" 
                            onclick="window.dashboard && window.dashboard.closeModal('edit-modal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="btn btn-primary" id="btn-save">ä¿å­˜ã™ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- ç”»åƒç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="ad-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">ç”»åƒç®¡ç†è¨­å®š</div>
                <p class="modal-description">æœ€å¤§5æšã¾ã§ç™»éŒ²ã§ãã¾ã™ã€‚</p>
                <div id="ad-list-container"></div>
                <div id="ad-add-btn-wrapper">
                    <div class="btn-add-area" 
                         onclick="window.dashboard && window.dashboard.triggerAdUpload('add')">
                        <span class="icon-add">+</span> ç”»åƒã‚’è¿½åŠ ã™ã‚‹
                    </div>
                </div>
                <p id="ad-limit-alert" class="limit-alert">â€» æœ€å¤§æšæ•°(5æš)ã«é”ã—ã¦ã„ã¾ã™</p>
                <div class="modal-footer">
                    <button class="btn btn-secondary" 
                            onclick="window.dashboard && window.dashboard.closeModal('ad-modal')">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>

        <input type="file" id="ad-file-input" accept="image/*" hidden>
    </div>

    <script type="module">
        import { login, loginWithGoogle, logout, onAuthChange, isUserAdmin } from './config.js';

        // Firebase SDKèª­ã¿è¾¼ã¿æˆåŠŸã‚’é€šçŸ¥
        window.firebaseLoaded = true;

        // DOMè¦ç´ 
        const loadingOverlay = document.getElementById('loadingOverlay');
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const loginError = document.getElementById('loginError');

        let dashboardInitialized = false;

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthChange(async (user) => {
            if (user) {
                const isAdmin = await isUserAdmin(user);
                if (isAdmin) {
                    showApp(user);
                } else {
                    await logout();
                    showLoginError('ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            } else {
                showLogin();
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            loginError.style.display = 'none';
            
            const result = await login(email, password);
            if (!result.success) {
                showLoginError(result.error);
            }
            
            btn.disabled = false;
            btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        });

        // Googleãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            loginError.style.display = 'none';
            const result = await loginWithGoogle();
            if (!result.success) {
                showLoginError(result.error);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            loadingOverlay.style.display = 'flex';
            await logout();
        });

        // UIè¡¨ç¤ºåˆ‡æ›¿
        function showApp(user) {
            loadingOverlay.style.display = 'none';
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            initDashboard();
        }

        function showLogin() {
            loadingOverlay.style.display = 'none';
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showLoginError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
            loadingOverlay.style.display = 'none';
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function initDashboard() {
            if (dashboardInitialized) return;
            
            // dashboard.jsã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
            if (window.dashboard && window.dashboard.init) {
                dashboardInitialized = true;
                window.dashboard.init();
            } else {
                // ã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯å°‘ã—å¾…ã£ã¦ãƒªãƒˆãƒ©ã‚¤
                setTimeout(initDashboard, 100);
            }
        }
    </script>
    
    <script type="module" src="dashboard.js"></script>
</body>
</html>