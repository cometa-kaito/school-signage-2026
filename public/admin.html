<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã‚µã‚¤ãƒãƒ¼ã‚¸ç®¡ç† | Edix</title>
    <link rel="stylesheet" href="auth-style.css">
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
        }

        body {
            font-family: sans-serif;
            background: var(--bg);
            padding: 0;
            margin: 0;
            color: #333;
        }

        /* ã‚¢ãƒ—ãƒªæœ¬ä½“ */
        #appContainer {
            display: none;
            padding: 20px;
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .app-header h1 {
            font-size: 1.2rem;
            color: var(--primary);
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ã‚«ãƒ¼ãƒ‰ */
        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: opacity 0.3s, background 0.3s;
        }

        .card.disabled {
            opacity: 0.5;
            background: #f5f5f5;
            pointer-events: none;
        }

        .card.disabled label {
            color: #999;
        }

        .card.disabled input {
            background: #eee;
            color: #999;
            cursor: not-allowed;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 16px;
            box-sizing: border-box;
        }

        /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¡Œ */
        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }

        .checkbox-row input[type="checkbox"] {
            width: auto;
            margin: 0;
            padding: 0;
        }

        /* ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .optional-section {
            margin-top: 16px;
            border-top: 1px solid #eee;
            padding-top: 12px;
        }

        .optional-header {
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 0;
            user-select: none;
        }

        .optional-header:hover {
            color: var(--accent);
        }

        .optional-fields {
            padding-top: 8px;
        }

        .optional-fields.hidden {
            display: none;
        }

        /* ã‚¿ãƒ– */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: #ddd;
            border-radius: 8px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: background 0.2s;
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        /* é€ä¿¡ãƒœã‚¿ãƒ³ */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }

        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .submit-btn:hover:not(:disabled) {
            background: #1a252f;
        }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
        .hidden {
            display: none;
        }
    </style>
    <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Firebase SDKãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç† -->
    <script>
        window.firebaseLoaded = false;
        setTimeout(function() {
            if (!window.firebaseLoaded) {
                var login = document.getElementById('loginContainer');
                var error = document.getElementById('loginError');
                if (login) login.style.display = 'flex';
                if (error) {
                    error.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚Firebaseã¸ã®æ¥ç¶šãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
                    error.style.display = 'block';
                }
            }
        }, 5000);
    </script>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <h2>ğŸ” ç®¡ç†è€…ãƒ­ã‚°ã‚¤ãƒ³</h2>
            
            <div id="loginError" class="error-msg"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" id="loginEmail" required 
                           placeholder="admin@example.com" autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                    <input type="password" id="loginPassword" required 
                           placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" autocomplete="current-password">
                </div>
                <button type="submit" id="loginBtn" class="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            
            <div class="divider"><span>ã¾ãŸã¯</span></div>
            
            <button type="button" id="googleLoginBtn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google">
                Googleã§ãƒ­ã‚°ã‚¤ãƒ³
            </button>
            
            <p class="login-note">â€»ç®¡ç†è€…ã®ã¿ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™</p>
        </div>
    </div>

    <!-- ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <div id="appContainer">
        <div class="app-header">
            <h1>ğŸ“¢ é€£çµ¡äº‹é …ã®ç™»éŒ²</h1>
            <div class="header-right">
                <span id="userEmail" class="user-email"></span>
                <button id="logoutBtn" class="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div id="successMsg" class="success-msg">ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</div>
        <div id="errorMsg" class="error-msg"></div>

        <div class="card" id="target-date-card">
            <label for="target-date">å¯¾è±¡æ—¥</label>
            <input type="date" id="target-date">
        </div>

        <div class="tabs">
            <button class="tab-btn active" data-tab="schedule">äºˆå®š</button>
            <button class="tab-btn" data-tab="notice">é€£çµ¡</button>
            <button class="tab-btn" data-tab="assignment">æå‡ºç‰©</button>
        </div>

        <div class="card">
            <div id="form-schedule">
                <label for="sched-time-select">æ™‚é–“</label>
                <select id="sched-time-select" onchange="toggleCustomTime()">
                    <option value="">-- é¸æŠ --</option>
                    <option value="çµ‚æ—¥">çµ‚æ—¥ (All Day)</option>
                    <option value="1é™">1é™</option>
                    <option value="2é™">2é™</option>
                    <option value="3é™">3é™</option>
                    <option value="4é™">4é™</option>
                    <option value="5é™">5é™</option>
                    <option value="6é™">6é™</option>
                    <option value="ãã®ä»–">ãã®ä»–ï¼ˆè‡ªç”±å…¥åŠ›ï¼‰</option>
                </select>
                <div id="custom-time-group" style="display: none;">
                    <label for="sched-time-custom">è‡ªç”±å…¥åŠ›</label>
                    <input type="text" id="sched-time-custom" placeholder="ä¾‹: æ”¾èª²å¾Œ, 13:30">
                </div>
                <label for="sched-content">å†…å®¹</label>
                <input type="text" id="sched-content" placeholder="é¿é›£è¨“ç·´">
                <label for="sched-location">å ´æ‰€</label>
                <input type="text" id="sched-location" placeholder="ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰">
                
                <div class="optional-section">
                    <div class="optional-header" onclick="toggleOptional('sched-optional')">
                        â–¶ è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    </div>
                    <div id="sched-optional" class="optional-fields hidden">
                        <label for="sched-display-start">è¡¨ç¤ºé–‹å§‹æ—¥</label>
                        <input type="date" id="sched-display-start">
                        <label for="sched-display-end">è¡¨ç¤ºçµ‚äº†æ—¥</label>
                        <input type="date" id="sched-display-end">
                    </div>
                </div>
            </div>

            <div id="form-notice" class="hidden">
                <label for="notice-text">é€£çµ¡å†…å®¹</label>
                <textarea id="notice-text" rows="3" placeholder="ä½“æ“æœã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«"></textarea>
                <div class="checkbox-row">
                    <input type="checkbox" id="notice-highlight">
                    <span style="color: #e74c3c;">é‡è¦ï¼ˆèµ¤å­—ã«ã™ã‚‹ï¼‰</span>
                </div>
                
                <div class="optional-section">
                    <div class="optional-header" onclick="toggleOptional('notice-optional')">
                        â–¶ è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    </div>
                    <div id="notice-optional" class="optional-fields hidden">
                        <label for="notice-display-start">è¡¨ç¤ºé–‹å§‹æ—¥</label>
                        <input type="date" id="notice-display-start">
                        <label for="notice-display-end">è¡¨ç¤ºçµ‚äº†æ—¥</label>
                        <input type="date" id="notice-display-end">
                    </div>
                </div>
            </div>

            <div id="form-assignment" class="hidden">
                <label for="assign-deadline">æå‡ºæœŸé™</label>
                <input type="date" id="assign-deadline">
                <label for="assign-subject">ç§‘ç›®</label>
                <select id="assign-subject">
                    <option value="å®Ÿç¿’">å®Ÿç¿’</option>
                    <option value="æ•°å­¦">æ•°å­¦</option>
                    <option value="è‹±èª">è‹±èª</option>
                    <option value="HR">ãƒ›ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ </option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
                <label for="assign-task">æå‡ºç‰©å</label>
                <input type="text" id="assign-task" placeholder="ãƒ¬ãƒãƒ¼ãƒˆ">
            </div>

            <button class="submit-btn" id="submitBtn">ç™»éŒ²ã™ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { 
            db, 
            SCHOOL_ID, 
            login, 
            loginWithGoogle, 
            logout, 
            onAuthChange, 
            isUserAdmin 
        } from './config.js';
        import { 
            doc, 
            setDoc, 
            arrayUnion 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase SDKèª­ã¿è¾¼ã¿æˆåŠŸã‚’é€šçŸ¥
        window.firebaseLoaded = true;

        // DOMè¦ç´ 
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const loginError = document.getElementById('loginError');
        const successMsg = document.getElementById('successMsg');
        const errorMsg = document.getElementById('errorMsg');

        // ã‚¢ãƒ—ãƒªçŠ¶æ…‹
        let currentMode = 'schedule';
        let appInitialized = false;

        // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
        onAuthChange(async (user) => {
            if (user) {
                const isAdmin = await isUserAdmin(user);
                if (isAdmin) {
                    showApp(user);
                } else {
                    await logout();
                    showError('ç®¡ç†è€…æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“');
                }
            } else {
                showLogin();
            }
        });

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ä¸­...';
            hideError();
            
            const result = await login(email, password);
            if (!result.success) {
                showError(result.error);
            }
            
            btn.disabled = false;
            btn.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³';
        });

        // Googleãƒ­ã‚°ã‚¤ãƒ³
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            hideError();
            const result = await loginWithGoogle();
            if (!result.success) {
                showError(result.error);
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        document.getElementById('logoutBtn').addEventListener('click', () => logout());

        // UIè¡¨ç¤ºåˆ‡æ›¿
        function showApp(user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            initApp();
        }

        function showLogin() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showError(msg) {
            loginError.textContent = msg;
            loginError.style.display = 'block';
        }

        function hideError() {
            loginError.style.display = 'none';
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        function initApp() {
            if (appInitialized) return;
            appInitialized = true;
            
            document.getElementById('target-date').value = new Date().toISOString().split('T')[0];
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });
            
            document.getElementById('submitBtn').addEventListener('click', submitData);
        }

        function switchTab(type) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('[id^="form-"]').forEach(f => f.classList.add('hidden'));
            document.querySelector(`[data-tab="${type}"]`).classList.add('active');
            document.getElementById(`form-${type}`).classList.remove('hidden');
            currentMode = type;
            
            // æå‡ºç‰©ã‚¿ãƒ–ã®å ´åˆã¯å¯¾è±¡æ—¥ã‚«ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆå…¥åŠ›ä¸å¯ï¼‰
            const targetDateCard = document.getElementById('target-date-card');
            const targetDateInput = document.getElementById('target-date');
            if (targetDateCard && targetDateInput) {
                if (type === 'assignment') {
                    targetDateCard.classList.add('disabled');
                    targetDateInput.disabled = true;
                } else {
                    targetDateCard.classList.remove('disabled');
                    targetDateInput.disabled = false;
                }
            }
        }

        // ãã®ä»–é¸æŠæ™‚ã®è‡ªç”±å…¥åŠ›è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleCustomTime = function() {
            const select = document.getElementById('sched-time-select');
            const customGroup = document.getElementById('custom-time-group');
            if (select && customGroup) {
                customGroup.style.display = select.value === 'ãã®ä»–' ? 'block' : 'none';
            }
        };

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleOptional = function(id) {
            const el = document.getElementById(id);
            const header = el?.previousElementSibling;
            if (el) {
                const isHidden = el.classList.contains('hidden');
                el.classList.toggle('hidden');
                if (header) {
                    header.textContent = (isHidden ? 'â–¼' : 'â–¶') + ' è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰';
                }
            }
        };

        async function submitData() {
            const btn = document.getElementById('submitBtn');
            
            btn.disabled = true;
            btn.textContent = 'é€ä¿¡ä¸­...';
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            try {
                let dateStr;
                
                if (currentMode === 'assignment') {
                    // æå‡ºç‰©ã®å ´åˆã¯æœŸé™æ—¥ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
                    dateStr = document.getElementById('assign-deadline').value;
                    if (!dateStr) throw new Error("æå‡ºæœŸé™ã‚’é¸æŠã—ã¦ãã ã•ã„");
                } else {
                    // äºˆå®šãƒ»é€£çµ¡ã®å ´åˆã¯å¯¾è±¡æ—¥ã‚’ä½¿ç”¨
                    dateStr = document.getElementById('target-date').value;
                    if (!dateStr) throw new Error("å¯¾è±¡æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");
                }

                const docRef = doc(db, "schools", SCHOOL_ID, "daily_data", dateStr);
                const updateData = buildUpdateData(dateStr);

                await setDoc(docRef, updateData, { merge: true });
                
                clearForm();
                successMsg.style.display = 'block';
                setTimeout(() => successMsg.style.display = 'none', 3000);
            } catch (error) {
                errorMsg.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
                errorMsg.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç™»éŒ²ã™ã‚‹';
            }
        }

        function buildUpdateData(dateStr) {
            const builders = {
                schedule: () => {
                    const content = document.getElementById('sched-content').value;
                    if (!content) throw new Error("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    
                    const selectValue = document.getElementById('sched-time-select').value;
                    const customValue = document.getElementById('sched-time-custom').value;
                    const time = selectValue === 'ãã®ä»–' ? customValue : selectValue;
                    
                    const scheduleData = {
                        time: time,
                        content,
                        location: document.getElementById('sched-location').value
                    };
                    
                    // è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    const displayStart = document.getElementById('sched-display-start').value;
                    const displayEnd = document.getElementById('sched-display-end').value;
                    if (displayStart) scheduleData.display_start = displayStart;
                    if (displayEnd) scheduleData.display_end = displayEnd;
                    
                    return {
                        date: dateStr,
                        schedules: arrayUnion(scheduleData)
                    };
                },
                notice: () => {
                    const text = document.getElementById('notice-text').value;
                    if (!text) throw new Error("å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    
                    const noticeData = {
                        text,
                        is_highlight: document.getElementById('notice-highlight').checked
                    };
                    
                    // è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                    const displayStart = document.getElementById('notice-display-start').value;
                    const displayEnd = document.getElementById('notice-display-end').value;
                    if (displayStart) noticeData.display_start = displayStart;
                    if (displayEnd) noticeData.display_end = displayEnd;
                    
                    return {
                        date: dateStr,
                        notices: arrayUnion(noticeData)
                    };
                },
                assignment: () => {
                    const deadline = document.getElementById('assign-deadline').value;
                    const task = document.getElementById('assign-task').value;
                    if (!deadline || !task) throw new Error("æœŸé™ã¨æå‡ºç‰©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                    return {
                        date: deadline,
                        assignments: arrayUnion({
                            deadline,
                            subject: document.getElementById('assign-subject').value,
                            task
                        })
                    };
                }
            };

            return builders[currentMode]();
        }

        function clearForm() {
            document.querySelectorAll('input[type="text"], textarea').forEach(el => el.value = '');
            const highlightCheckbox = document.getElementById('notice-highlight');
            if (highlightCheckbox) highlightCheckbox.checked = false;
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            const timeSelect = document.getElementById('sched-time-select');
            if (timeSelect) timeSelect.value = '';
            
            // ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“å…¥åŠ›ã‚’éè¡¨ç¤º
            const customGroup = document.getElementById('custom-time-group');
            if (customGroup) customGroup.style.display = 'none';
            
            // è¡¨ç¤ºæœŸé–“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
            const displayFields = [
                'sched-display-start', 'sched-display-end',
                'notice-display-start', 'notice-display-end'
            ];
            displayFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é–‰ã˜ã‚‹
            document.querySelectorAll('.optional-fields').forEach(el => {
                el.classList.add('hidden');
                const header = el.previousElementSibling;
                if (header) header.textContent = 'â–¶ è¡¨ç¤ºæœŸé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰';
            });
        }
    </script>
</body>
</html>